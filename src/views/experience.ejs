<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= experience.title %> | Roamly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-gray-100 text-gray-900">

  <!-- ✅ SHARED NAVBAR -->
  <%- include("partials/navbar") %>

  <main class="max-w-7xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-3 gap-10">

    <!-- ================= LEFT CONTENT ================= -->
    <section class="lg:col-span-2 space-y-8">

      <!-- IMAGE + TITLE -->
      <div>
        <img
          src="<%= experience.image %>"
          alt="<%= experience.title %>"
          class="w-full h-[360px] object-cover rounded-xl"
        />

        <h1 class="mt-6 text-2xl font-semibold">
          <%= experience.title %>
        </h1>

        <p class="mt-2 max-w-2xl text-sm text-gray-600">
          <%= experience.description %>
        </p>
      </div>

      <!-- DATE SELECTION -->
      <div>
        <h3 class="font-medium mb-3">Choose date</h3>

        <div class="flex flex-wrap gap-3">
          <% Object.keys(experience.availability).forEach(date => { %>
            <button
              class="date-chip px-4 py-2 border rounded-md text-sm hover:bg-gray-100"
              onclick="selectDate('<%= date %>', this)"
            >
              <%= date %>
            </button>
          <% }) %>
        </div>
      </div>

      <!-- TIME SELECTION -->
      <div>
        <h3 class="font-medium mb-3">Choose time</h3>

        <div id="timeSlots" class="flex flex-wrap gap-3 text-sm">
          <span class="text-gray-400">Select a date first</span>
        </div>

        <p class="mt-2 text-xs text-gray-400">
          All times are in IST (GMT +5:30)
        </p>
      </div>

      <!-- ABOUT / HIGHLIGHTS -->
      <div>
        <h3 class="font-medium mb-2">About</h3>
        <p class="bg-gray-50 border rounded-lg p-4 text-sm text-gray-600">
          <%= experience.highlights %>
        </p>
      </div>

    </section>

    <!-- ================= RIGHT SIDEBAR ================= -->
    <aside class="bg-gray-50 border rounded-xl p-6 h-fit sticky top-24 space-y-4">

      <!-- PRICE -->
      <div class="flex justify-between text-sm text-gray-600">
        <span>Starts at</span>
        <span class="font-semibold">₹<%= experience.price %></span>
      </div>

      <!-- SUMMARY -->
      <div class="space-y-1 text-sm text-gray-600">
        <div class="flex justify-between">
          <span>Date</span>
          <span id="summaryDate">—</span>
        </div>
        <div class="flex justify-between">
          <span>Time</span>
          <span id="summaryTime">—</span>
        </div>
      </div>

      <!-- QUANTITY -->
      <div class="flex justify-between items-center pt-2 text-sm">
        <span>Quantity</span>
        <div class="flex items-center gap-2">
          <button onclick="changeQty(-1)" class="px-2 border rounded">−</button>
          <span id="qty">1</span>
          <button onclick="changeQty(1)" class="px-2 border rounded">+</button>
        </div>
      </div>

      <hr />

      <!-- PRICE BREAKDOWN -->
      <div class="space-y-1 text-sm">
        <div class="flex justify-between">
          <span>Subtotal</span>
          <span>₹<span id="subTotal"><%= experience.price %></span></span>
        </div>
        <div class="flex justify-between">
          <span>Taxes</span>
          <span>₹59</span>
        </div>
        <div class="flex justify-between font-semibold text-base">
          <span>Total</span>
          <span>₹<span id="total"><%= experience.price + 59 %></span></span>
        </div>
      </div>

      <!-- CTA -->
      <button
        id="confirmBtn"
        disabled
        class="w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed"
      >
        Confirm
      </button>

    </aside>

  </main>

  <!-- ================= SCRIPT ================= -->
  <script>
    const availability = <%- JSON.stringify(experience.availability) %>;
    const price = <%= experience.price %>;
    const experienceId = "<%= experience._id %>";

    let qty = 1;
    let selectedDate = null;
    let selectedTime = null;

    const summaryDate = document.getElementById("summaryDate");
    const summaryTime = document.getElementById("summaryTime");
    const confirmBtn = document.getElementById("confirmBtn");
    const timeSlots = document.getElementById("timeSlots");

    function selectDate(date, btn) {
      selectedDate = date;
      selectedTime = null;

      summaryDate.textContent = date;
      summaryTime.textContent = "—";

      document.querySelectorAll(".date-chip")
        .forEach(b => b.classList.remove("bg-yellow-400"));

      btn.classList.add("bg-yellow-400");

      timeSlots.innerHTML = "";

      availability[date].forEach(t => {
        const b = document.createElement("button");
        b.className = "px-4 py-2 border rounded-md text-sm";

        if (t.slots === 0) {
          b.textContent = `${t.time} • Sold out`;
          b.disabled = true;
          b.classList.add("bg-gray-200", "text-gray-400");
        } else {
          b.innerHTML =
            t.slots <= 3
              ? `${t.time} <span class="text-red-500 ml-1">(${t.slots} left)</span>`
              : `${t.time} <span class="text-gray-500 ml-1">(${t.slots})</span>`;

          b.onclick = () => selectTime(t.time, b);
        }

        timeSlots.appendChild(b);
      });

      disableConfirm();
    }

    function selectTime(time, btn) {
      selectedTime = time;
      summaryTime.textContent = time;

      document.querySelectorAll("#timeSlots button")
        .forEach(b => b.classList.remove("bg-yellow-300"));

      btn.classList.add("bg-yellow-300");
      enableConfirm();
    }

    function changeQty(delta) {
      qty = Math.max(1, qty + delta);
      document.getElementById("qty").textContent = qty;
      document.getElementById("subTotal").textContent = price * qty;
      document.getElementById("total").textContent = price * qty + 59;
    }

    function enableConfirm() {
      confirmBtn.disabled = false;
      confirmBtn.className =
        "w-full bg-yellow-400 hover:bg-yellow-500 py-3 rounded-lg font-medium";
    }

    function disableConfirm() {
      confirmBtn.disabled = true;
      confirmBtn.className =
        "w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed";
    }

    confirmBtn.onclick = () => {
      if (!selectedDate || !selectedTime) return;

      fetch("/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ experienceId, date: selectedDate, time: selectedTime, qty })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) alert(data.message);
        else window.location.href = `/checkout/${data.bookingId}`;
      });
    };
  </script>

</body>
</html>
